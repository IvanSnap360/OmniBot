<launch>
    <!-- Arguments for launch file with defaults provided -->
    <arg name="database_path" default="/home/ivan/.ros/rtabmap.db"/>
    <!-- <arg name="model" default="$(env TURTLEBOT3_MODEL)" doc="model type [burger, waffle, waffle_pi]"/> -->
    <!--arg name="rgb_topic" default="/d400/color/image_raw"/>
    <arg name="depth_topic" default="/d400/depth/image_raw"/>
    <arg name="camera_info_topic" default="/d400/color/camera_info"/-->
    <arg name="rate"            default="1.0"/>
    <arg name="open_rviz" default="true"/>
    <arg name="move_forward_only" default="false"/>
  
    <param name="use_sim_time" type="bool" value="True"/>
    
    <!-- Localization-only mode -->
    <arg name="localization"      default="true"/>
    <arg     if="$(arg localization)" name="rtabmap_args"  default=""/>
    <arg unless="$(arg localization)" name="rtabmap_args"  default="--delete_db_on_start"/>
  
  
  
    <!-- Mapping Node -->
    <group ns="rtabmap">
      <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="--delete_db_on_start">
        <!-- Basic RTAB-Map Parameters -->
        <param name="database_path" type="string" value="$(arg database_path)"/>
        <param name="frame_id" type="string" value="base_footprint"/>
        <param name="wait_for_transform" type="bool" value="true"/>
        <param name="odom_frame_id" type="string" value="/t265_odom_frame"/>
        <param name="subscribe_depth" type="bool" value="true"/>
        <param name="subscribe_scan" type="bool" value="true"/>
  
        <!-- use actionlib to send goals to move_base --> 
        <param name="use_action_for_goal" type="bool" value="true"/>
        <remap from="move_base"            to="/move_base"/>
  
   
        <param name="odom_tf_linear_variance"  type="double" value="0.001"/>
        <param name="odom_tf_angular_variance" type="double" value="0.001"/>
  
        <!-- RTAB-Map Inputs -->
        <remap from="scan" to="/scan"/>
        <remap from="rgb/image" to="/d400/color/image_raw"/>
        <remap from="depth/image" to="/d400/depth/image_raw"/>
        <remap from="rgb/camera_info" to="/d400/color/camera_info"/>
        <remap from="/t265/odom/sample"            to="/odom"/>      
        <param name="rgb/image_transport"   type="string" value="compressed"/>
        <param name="depth/image_transport" type="string" value="compressedDepth"/>
  
        <remap from="grid_map" to="/map"/>  
        <param name="queue_size" type="int" value="100"/>
  
  
  
        <!-- RTAB-Map's parameters -->
        <param name="RGBD/NeighborLinkRefining" type="string" value="true"/>
        <param name="RGBD/ProximityBySpace"     type="string" value="true"/>
        <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/>
        <param name="RGBD/AngularUpdate"        type="string" value="0.05"/>
        <param name="RGBD/LinearUpdate"         type="string" value="0.05"/>
        <param name="Optimizer/Slam2D"          type="string" value="true"/>
        <param name="Reg/Force3DoF"             type="string" value="true"/>
        <param name="Reg/Strategy"              type="string" value="1"/> <!-- 1=ICP -->
        <param name="Vis/MinInliers"            type="string" value="5"/>
        <param name="Vis/InlierDistance"        type="string" value="0.1"/>
        <param name="Kp/MaxDepth"               type="string" value="1.75"/>
        <param name="Vis/MaxDepth"              type="string" value="1.75"/>
        <param name="Rtabmap/TimeThr"           type="string" value="700"/>
        <param name="Rtabmap/DetectionRate"     type="string" value="$(arg rate)" />
        <param name="Mem/RehearsalSimilarity"   type="string" value="0.45"/>
        <param name="Grid/MaxObstacleHeight"    type="string" value="1.7" />
        <param name="Grid/NoiseFilteringRadius" type="string" value="0.05"/>
        <param name="Grid/NoiseFilteringMinNeighbors" type="string" value="5"/>
        <param name="RGBD/ProximityByTime"      type="string" value="false"/> 
  
        <param name="RGBD/NeighborLinkRefining" type="string" value="true"/>  
        <param name="RGBD/ProximityBySpace"     type="string" value="true"/>  
        <param name="RGBD/ProximityPathMaxNeighbors" type="string" value="10"/> 
        <param name="Reg/Strategy"              type="string" value="1"/>     
        <param name="Vis/MinInliers"        type="string" value="12"/>   
        <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/> 
        <param name="RGBD/OptimizeMaxError"     type="string" value="3"/>	    
        <param name="Grid/FromDepth"            type="string" value="false"/> 
        <param name="Mem/STMSize"               type="string" value="30"/>    
        <param name="RGBD/LocalRadius"          type="string" value="5"/>    
        <param name="Icp/CorrespondenceRatio"   type="string" value="0.4"/>   
  
        <!-- Rate (Hz) at which new nodes are added to map -->
        <param name="Rtabmap/DetectionRate" type="string" value="1"/>
  
        <!-- localization mode -->
        <param     if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false"/>
        <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true"/>
        <param name="Mem/InitWMWithAllNodes" type="string" value="$(arg localization)"/>
      </node>
  
      <!-- visualization with rtabmapviz -->
      <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz"
            args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
        <param name="subscribe_depth" type="bool" value="true"/>
        <param name="subscribe_scan" type="bool" value="false"/>
        <param name="frame_id" type="string" value="base_footprint"/>
        <param name="wait_for_transform" type="bool" value="true"/>
        <remap from="scan" to="/scan"/>
        <remap from="rgb/image" to="/d400/color/image_raw"/>
        <remap from="depth/image" to="/d400/depth/image_raw"/>
        <remap from="rgb/camera_info" to="/d400/color/camera_info"/>
        <remap from="odom"            to="/odom"/>
        <param name="rgb/image_transport"   type="string" value="compressed"/>
        <param name="depth/image_transport" type="string" value="compressedDepth"/>
        
        <param name="queue_size" type="int" value="10"/>
      </node>
      
    </group>
  </launch>